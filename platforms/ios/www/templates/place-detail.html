<!--
  This template loads for the 'tab.place-detail' state (app.js)
  'firend' is a $scope variable created in the PlacesCtrl controller (controllers.js)
  The PlacesCtrl pulls data from the Places service (service.js)
  The Places service returns an array of friend data
-->
<ion-view title="{{place.name}}">
  <ion-content has-header="true" padding="true">

  	<div id='background'>
		<div class="row">
	  		<div class="col col-75">Distance ~

	          	<div id="outputDiv"></div>
	          	<p>ft</p>
	          	<div id="red"></div>
	          	<div id="warmOrCold">no change</div>
	          	<div id='latitude'></div>
	          	<div id='longitude'></div>


	  		</div>
		</div>
	</div>
	<div id="map-canvas"></div>

              <script type="text/javascript" charset="utf-8" src="cordova-2.5.0.js"></script>
    <script type="text/javascript" charset="utf-8">

    // Wait for Cordova to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

    var watchID = null;

    // Cordova is ready
    //
    function onDeviceReady() {
        // Throw an error if no update is received every 30 seconds
        var options = { timeout: 30000 };
        watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
    }

    // onSuccess Geolocation
    //
    function onSuccess(position) {
        var element = document.getElementById('geolocation');
        element.innerHTML = 'Latitude: '  + position.coords.latitude      + '<br />' +
                            'Longitude: ' + position.coords.longitude     + '<br />' +
                            '<hr />'      + element.innerHTML;
    }

    // onError Callback receives a PositionError object
    //
    function onError(error) {
        alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
    }

    var currentPosition = null;

    var id = localStorage.getItem('currentId');

    var latitude = localStorage.getItem('latitude' + id);

    var longitude = localStorage.getItem('longitude' + id);

    var distanceToItem = null;
    var lastDistance;

    var itemLocation = new google.maps.LatLng(29.4167, -98.5000);

    var map;
	var geocoder;
	var bounds = new google.maps.LatLngBounds();
	var markersArray = [];

	var origin1 = new google.maps.LatLng(29.4167, -98.5000);


	var destinationIcon = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=D|FF0000|000000';
	var originIcon = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=O|FFFF00|000000';

    function initialize() {
	  var opts = {
	    center: new google.maps.LatLng(55.53, 9.4),
	    zoom: 10
	  };
	  map = new google.maps.Map(document.getElementById('map-canvas'), opts);
	  geocoder = new google.maps.Geocoder();
	}

	function calculateDistances() {
		console.log(currentPosition);
		var destinationB = new google.maps.LatLng(currentPosition.coords.latitude, currentPosition.coords.longitude);
		// console.log(latitude);
		// console.log(longitude);
		console.log(google.maps.geometry.spherical.computeDistanceBetween(origin1, destinationB));
	}

    function calcCurrentDistance() {   
    	console.log('running calc distance');
		//If HTML5 Geolocation Is Supported In This Browser 
		if (navigator.geolocation) {        
			//Use HTML5 Geolocation API To Get Current Position      
			navigator.geolocation.getCurrentPosition(function(position){        


				//Define New Google Map With Lat / Lon      
				var currentLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);  
				currentPosition = position;      

				//Specify Google Map Options      
				var mapOptions = {           
					zoom: 15,           
					center: currentLocation,           
					mapTypeControl: true,           
					navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL}, 
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};          
          

				distanceToItem = google.maps.geometry.spherical.computeDistanceBetween(itemLocation, currentLocation);

				if (distanceToItem != null) {
					$('#outputDiv').html(distanceToItem);
				};

				if (distanceToItem != null && lastDistance != null && (distanceToItem < lastDistance)) {
					$('#warmOrCold').html('WARMER');
					$('#background').css('background-color', '#F00');
				} else if (distanceToItem != null && lastDistance != null && (distanceToItem > lastDistance)) {
					$('#warmOrCold').html('COLDER');
					$('#background').css('background-color', '#00F');
				};

				lastDistance = distanceToItem;
			});  

		} else {        
			//Otherwise - Gracefully Fall Back If Not Supported... Probably Best Not To Use A JS Alert Though :)      
			alert("Geolocation API is not supported in your browser."); 
		}  
	}

	calcCurrentDistance();

	setInterval(calcCurrentDistance, 10000);


    $('#calcDistance').on('click', function () {
    	calculateDistances();
    });

	google.maps.event.addDomListener(window, 'load', initialize);
	</script>
	 <!-- <p id="geolocation">Watching geolocation...</p> -->
  </ion-content>
</ion-view>
